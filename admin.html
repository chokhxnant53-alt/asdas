<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô | Flash Express</title>
  <link rel="icon" href="https://flashexpress.com/favicon.ico" type="image/x-icon">
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;600&display=swap" rel="stylesheet">

  <style>
    body {
      font-family: "Prompt", sans-serif;
      background-color: #fffbea;
      margin: 0;
      padding: 0;
    }

    header {
      background: #ffeb3b;
      text-align: center;
      padding: 18px;
      font-weight: bold;
      font-size: 22px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .container {
      padding: 20px;
      width: 90%;
      max-width: 1200px;
      margin: 25px auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 3px 6px rgba(0,0,0,0.1);
    }

    h3 {
      text-align: center;
      color: #5e35b1;
      font-size: 20px;
      margin-top: 30px;
    }

    input[type="text"] {
      display: block;
      width: 90%;
      max-width: 450px;
      margin: 15px auto 30px;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid #ccc;
      text-align: center;
      font-size: 15px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 25px;
    }

    th, td {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: center;
      font-size: 14px;
      white-space: nowrap;
    }

    th {
      background: #ffeb3b;
      font-weight: bold;
    }

    button {
      border: none;
      border-radius: 6px;
      padding: 7px 12px;
      cursor: pointer;
      font-weight: bold;
      font-size: 13px;
      transition: 0.2s;
    }

    .btn-green { background: #4CAF50; color: white; }
    .btn-green:hover { background: #43a047; }
    .btn-red   { background: #f44336; color: white; }
    .btn-red:hover { background: #e53935; }
    .btn-blue  { background: #2196F3; color: white; }
    .btn-blue:hover { background: #1e88e5; }

    .logout {
      display: block;
      margin: 25px auto 10px;
      background: #ff5252;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 12px 25px;
      font-weight: bold;
      font-size: 15px;
      cursor: pointer;
      transition: 0.2s;
    }
    .logout:hover { background: #e53935; }
  </style>
</head>
<body>

  <header>üë®‚Äçüíº ‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô - ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</header>

  <div class="container">
    <h3>üì± ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
    <input type="text" id="searchInput" placeholder="üîç ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...">

    <table id="customerTable">
      <thead>
        <tr>
          <th>#</th>
          <th>‡∏ä‡∏∑‡πà‡∏≠ / ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</th>
          <th>‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th>
          <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏°‡∏±‡∏Ñ‡∏£</th>
          <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <button class="logout" onclick="logout()">üö™ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getDatabase, ref, get, set, update } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

    // üî• ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Firebase ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
    const firebaseConfig = {
      apiKey: "AIzaSyALSOECmTwrVr0RQAp_b632HmxQ0sJvLMw",
      authDomain: "flash-claim-system.firebaseapp.com",
      databaseURL: "https://flash-claim-system-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "flash-claim-system",
      storageBucket: "flash-claim-system.firebasestorage.app",
      messagingSenderId: "369180040049",
      appId: "1:369180040049:web:6753f5e48a23bc6737b4d0",
      measurementId: "G-VLVBY60G3Q"
    };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // üü° ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå Admin
    if (sessionStorage.getItem("isAdminLoggedIn") !== "true") {
      alert("‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô");
      window.location.href = "admin-login.html";
    }

    const customerTable = document.querySelector("#customerTable tbody");
    const searchInput = document.getElementById("searchInput");

    // ‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏à‡∏≤‡∏Å Firebase
    async function loadCustomers() {
      const snapshot = await get(ref(db, "customers"));
      customerTable.innerHTML = "";
      if (!snapshot.exists()) {
        customerTable.innerHTML = `<tr><td colspan="5">‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</td></tr>`;
        return;
      }
      const customers = snapshot.val();
      const filter = searchInput.value.trim().toLowerCase();
      let index = 0;

      Object.keys(customers).forEach(phone => {
        const c = customers[phone];
        if (filter && !phone.includes(filter) && !(c.name || "").toLowerCase().includes(filter)) return;

        index++;
        const balance = c.wallet_balance || 0;
        const createdAt = c.createdAt || "-";
        customerTable.innerHTML += `
          <tr>
            <td>${index}</td>
            <td><b>${c.name || "-"}</b><br>${phone}</td>
            <td>${balance.toLocaleString("th-TH", { minimumFractionDigits: 2 })}</td>
            <td>${createdAt}</td>
            <td>
              <button class="btn-green" onclick="topUp('${phone}')">‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô</button>
              <button class="btn-red" onclick="withdraw('${phone}')">‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</button>
              <button class="btn-blue" onclick="viewAccount('${phone}')">‡∏î‡∏π‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</button>
            </td>
          </tr>
        `;
      });

      if (index === 0)
        customerTable.innerHTML = `<tr><td colspan="5">‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</td></tr>`;
    }

    loadCustomers();
    searchInput.addEventListener("input", loadCustomers);

    // üí∞ ‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô
    window.topUp = async function(phone) {
      const amount = parseFloat(prompt(`üí∏ ‡πÉ‡∏™‡πà‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏¥‡∏°‡πÉ‡∏´‡πâ‡πÄ‡∏ö‡∏≠‡∏£‡πå ${phone}:`));
      if (isNaN(amount) || amount <= 0) return alert("‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");

      const snap = await get(ref(db, "customers/" + phone));
      if (!snap.exists()) return alert("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏£‡∏≤‡∏¢‡∏ô‡∏µ‡πâ");
      const data = snap.val();
      const newBalance = (data.wallet_balance || 0) + amount;

      await update(ref(db, "customers/" + phone), { wallet_balance: newBalance });
      alert(`‚úÖ ‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏ö‡∏≠‡∏£‡πå ${phone} ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ${amount.toFixed(2)} ‡∏ö‡∏≤‡∏ó‡πÅ‡∏•‡πâ‡∏ß`);
      loadCustomers();
    };

    // üí∏ ‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô
    window.withdraw = async function(phone) {
      const amount = parseFloat(prompt(`üí∞ ‡πÉ‡∏™‡πà‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ñ‡∏≠‡∏ô‡∏à‡∏≤‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå ${phone}:`));
      if (isNaN(amount) || amount <= 0) return alert("‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");

      const snap = await get(ref(db, "customers/" + phone));
      if (!snap.exists()) return alert("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏£‡∏≤‡∏¢‡∏ô‡∏µ‡πâ");
      const data = snap.val();

      if ((data.wallet_balance || 0) < amount)
        return alert("‚ùå ‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠");

      const newBalance = (data.wallet_balance || 0) - amount;
      await update(ref(db, "customers/" + phone), { wallet_balance: newBalance });
      alert(`üí∏ ‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏à‡∏≤‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå ${phone} ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ${amount.toFixed(2)} ‡∏ö‡∏≤‡∏ó‡πÅ‡∏•‡πâ‡∏ß`);
      loadCustomers();
    };

    // üëÅ‚Äçüó® ‡∏î‡∏π‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
    window.viewAccount = function(phone) {
      window.open(`account.html?phone=${phone}`, "_blank");
    };

    // üö™ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
    window.logout = function() {
      sessionStorage.removeItem("isAdminLoggedIn");
      alert("‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß");
      window.location.href = "admin-login.html";
    };
  </script>
</body>
</html>
